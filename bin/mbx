#!/usr/bin/env python3
# coding: utf-8

from __future__ import unicode_literals, print_function
import os
import re
import sys
import argparse
import importlib
import molbiox.execute
from molbiox.frame.command import Command


def load_commands():
    regex = re.compile(r'^([a-z][_a-z0-9]*)\.py$')    # subset of a valid module name
    dirpath = os.path.dirname(molbiox.execute.__file__)
    for filename in os.listdir(dirpath):
        mat = regex.match(filename)
        if mat:
            modname = 'molbiox.execute.' + mat.groups()[0]
            importlib.import_module(modname)


desc = 'Molbiox Project'
parser = argparse.ArgumentParser(description=desc)
subparsers = parser.add_subparsers(dest='subcmd', help='mbx <subcommand>')
subparsers.add_parser('help')

load_commands()


for cls in Command.__trackdict__['abbr'].values():
    subparser = subparsers.add_parser(cls.name, aliases=[cls.abbr], help=cls.desc)
    cls.register(subparser)

args = parser.parse_args()
if args.subcmd in Command.__trackdict__['abbr']:
    Command.__trackdict__['abbr'][args.subcmd].run(args)
elif args.subcmd in Command.__trackdict__['name']:
    Command.__trackdict__['name'][args.subcmd].run(args)
else:
    print('command not found', file=sys.stderr)
