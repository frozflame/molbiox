#!/usr/bin/env python3
# coding: utf-8

from __future__ import unicode_literals, print_function

import os
import sys
import argparse

from molbiox.algor import relational
from molbiox.io import hmmscan


ext_tophit = '.hscanT'


if __name__ == '__main__':

    desc = 'Parse a TBLOUT file generated by hmmscan'
    parser = argparse.ArgumentParser(description=desc)

    parser.add_argument(
        '--rude', action='store_true',
        help='overwriting existing files if needed')

    parser.add_argument(
        'filenames', metavar='TBLOUT-file', nargs='+',
        help='a TBLOUT-file generated by hmmscan')

    args = parser.parse_args()

    for filename in args.filenames:
        # be polite: do not overwrite existing file
        filename_out = filename + ext_tophit
        if not args.rude and os.path.exists(filename_out):
            message = 'Fail: "{}" exists already'.format(filename_out)
            print(message, file=sys.stderr)
            continue

        records = hmmscan.read_tblout(filename)
        hitdict = relational.select_top_records(records, 'query.name')
        with open(filename_out, 'w') as outfile:
            for key, rec in hitdict.items():
                access = rec['target.accession']
                target = rec['target.name']
                evalue = rec['bestdom.evalue']
                print(key, access, evalue, target, sep='\t', file=outfile)



